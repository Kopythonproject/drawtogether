<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê·¸ë¦¼íŒ (ë„êµ¬ & ìƒ‰ìƒ + ì´ë¯¸ì§€ ì‚½ì…)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fb;
      display: flex;
      height: 100vh;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
    }
    #header h2 {
      margin: 0;
      font-size: 1.5rem;
    }
    #closeBtn {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: red;
      cursor: pointer;
    }

    #canvasContainer {
      flex: 1;
      border: 1px solid #ccc;
      background-image: linear-gradient(#eee 1px, transparent 1px),
                        linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 20px 20px;
      position: relative;
      user-select: none;
    }

    canvas {
      position: absolute;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: transparent;
    }

    #toolbar {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #toolbar button {
      padding: 8px 12px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #eee;
      transition: background-color 0.3s;
      position: relative;
    }

    #toolbar button:hover {
      background-color: #ddd;
    }

    /* ë„êµ¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    #toolDropdown {
      position: absolute;
      top: 40px;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
      width: 150px;
    }

    #toolDropdown div {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #toolDropdown div:hover {
      background-color: #eee;
    }

    /* ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
    #colorPicker {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: 10px;
    }
    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      box-sizing: border-box;
    }
    .color-swatch.selected {
      border-color: #333;
    }

    /* ì´ë¯¸ì§€ ì‚½ì… ëª¨ë‹¬ */
    #imageInsertModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: none;
      z-index: 200;
      width: 300px;
    }
    #imageInsertModal h3 {
      margin: 0 0 10px;
      font-size: 1.2rem;
    }
    #imageInsertModal .sticker-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #imageInsertModal .sticker-list img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #imageInsertModal .sticker-list img:hover {
      border-color: #2196F3;
    }
    #imageInsertModal button.close-modal {
      margin-top: 10px;
      padding: 6px 12px;
      border: none;
      background-color: #f44336;
      color: white;
      cursor: pointer;
      border-radius: 6px;
      float: right;
    }

    #chatArea {
      width: 280px;
      background: #fff;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    #chatInput {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ccc;
    }
    #chatInput input {
      flex: 1;
      padding: 6px;
    }
    #chatInput button {
      padding: 6px 12px;
    }

    #createRoomBtn {
      margin: 10px;
      padding: 8px 16px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      background-color: #2196F3;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button id="createRoomBtn" style="display:none;">ìƒˆ ë°© ë§Œë“¤ê¸°</button>

  <div id="main" style="display:none;">
    <div id="header">
      <h2>ğŸ”¥ ê·¸ë¦¼íŒ - ë°© ì œëª©</h2>
      <button id="closeBtn">âŒ</button>
    </div>
    <div id="canvasContainer">
      <canvas id="drawCanvas"></canvas>
    </div>
    <div id="toolbar">
      <button id="penBtn">âœï¸ íœ â–¼</button>
      <button id="eraserBtn">ğŸ§½ ì§€ìš°ê°œ</button>
      <button id="addImageBtn">â• ì´ë¯¸ì§€ì‚½ì…</button>
      <button id="permissions">âš™ï¸ ê¶Œí•œ ì„¤ì •</button>

        <!-- êµµê¸° ì¡°ì ˆ ìŠ¬ë¼ì´ë” -->
  <label for="lineWidthRange" style="margin-left:10px;">êµµê¸°:</label>
  <input type="range" id="lineWidthRange" min="1" max="50" value="2" step="1" style="vertical-align:middle;">


      <!-- ë„êµ¬ ë“œë¡­ë‹¤ìš´ -->
      <div id="toolDropdown">
        <div data-tool="pencil">âœï¸ ì—°í•„</div>
        <div data-tool="highlighter">ğŸ–ï¸ í•˜ì´ë¼ì´í„°</div>
        <div data-tool="brush">ğŸ–Œï¸ ë¶“</div>
      </div>

      <!-- ìƒ‰ìƒ ì„ íƒ -->
      <div id="colorPicker">
        <div class="color-swatch selected" style="background:#000000" data-color="#000000"></div>
        <div class="color-swatch" style="background:#ff0000" data-color="#ff0000"></div>
        <div class="color-swatch" style="background:#00ff00" data-color="#00ff00"></div>
        <div class="color-swatch" style="background:#0000ff" data-color="#0000ff"></div>
        <div class="color-swatch" style="background:#ffff00" data-color="#ffff00"></div>
        <div class="color-swatch" style="background:#ff00ff" data-color="#ff00ff"></div>
        <div class="color-swatch" style="background:#00ffff" data-color="#00ffff"></div>
        <div class="color-swatch" style="background:#ffffff; border: 1px solid #ccc;" data-color="#ffffff"></div>
      </div>
    </div>
  </div>

  <div id="chatArea" style="display:none;">
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="chatText" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
      <button id="sendChat">â¬†ï¸</button>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì‚½ì… ëª¨ë‹¬ -->
  <div id="imageInsertModal">
    <h3>ì´ë¯¸ì§€(ìŠ¤í‹°ì»¤) ì„ íƒ</h3>
    <div class="sticker-list">
      <img src="https://i.imgur.com/6YVXLhM.png" alt="ìŠ¤í‹°ì»¤1" data-url="https://i.imgur.com/6YVXLhM.png" />
      <img src="https://i.imgur.com/6WZ4L03.png" alt="ìŠ¤í‹°ì»¤2" data-url="https://i.imgur.com/6WZ4L03.png" />
      <img src="https://i.imgur.com/JkZclLk.png" alt="ìŠ¤í‹°ì»¤3" data-url="https://i.imgur.com/JkZclLk.png" />
    </div>
    <button class="close-modal">ë‹«ê¸°</button>
  </div>

  

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyDwTegUMVEfiLymObTxz4Camhtb84RkUtw",
  authDomain: "draw-f2d10.firebaseapp.com",
  databaseURL: "https://draw-f2d10-default-rtdb.firebaseio.com",
  projectId: "draw-f2d10",
  storageBucket: "draw-f2d10.appspot.com",
  messagingSenderId: "177556350348",
  appId: "1:177556350348:web:d8b35cdc76f7b68fa3e2a9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('roomId');

let currentUser = null;
let myPermissions = { draw: false, erase: false }; // â† ì—¬ê¸°ì— ì¶”ê°€


const createRoomBtn = document.getElementById('createRoomBtn');
const mainDiv = document.getElementById('main');
const chatArea = document.getElementById('chatArea');
const permBtn = document.getElementById('permissions');
const toolDropdown = document.getElementById('toolDropdown');
const penBtn = document.getElementById('penBtn');
const eraserBtn = document.getElementById('eraserBtn');
const addImageBtn = document.getElementById('addImageBtn');
const colorPicker = document.getElementById('colorPicker');
const imageInsertModal = document.getElementById('imageInsertModal');
const closeBtn = document.getElementById('closeBtn');

const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

let drawing = false;
let currentTool = 'pencil'; // pencil, highlighter, brush, eraser
let currentColor = '#000000';
let lastPos = null;

function resizeCanvas() {
  const container = canvas.parentElement;
  const width = container.clientWidth;
  const height = container.clientHeight;
  const dpr = window.devicePixelRatio || 1;

  // ì‹¤ì œ í”½ì…€ í¬ê¸° ì§€ì •
  canvas.width = width * dpr;
  canvas.height = height * dpr;

  // CSS í¬ê¸° ì§€ì • (í™”ë©´ í‘œì‹œ í¬ê¸°)
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';

  // ë Œë”ë§ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ê³ í•´ìƒë„ ëŒ€ì‘ ìŠ¤ì¼€ì¼ë§
  ctx.resetTransform();  // ê¸°ì¡´ ë³€í™˜ ì´ˆê¸°í™” (í¬ë¡¬, ìµœì‹  ë¸Œë¼ìš°ì € ì§€ì›)
  ctx.scale(dpr, dpr);
}

window.addEventListener('resize', resizeCanvas);
window.addEventListener('DOMContentLoaded', resizeCanvas); // DOM ì™„ì„± ì‹œ ì´ˆê¸°í™”

function resizeCanvasAndRedraw() {
  const container = canvas.parentElement;
  const width = container.clientWidth;
  const height = container.clientHeight;
  const dpr = window.devicePixelRatio || 1;

  // ìº”ë²„ìŠ¤ í¬ê¸° ì„¸íŒ… (ì‹¤ì œ í”½ì…€ ìˆ˜)
  canvas.width = width * dpr;
  canvas.height = height * dpr;

  // CSS í¬ê¸°
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';

  ctx.resetTransform();
  ctx.scale(dpr, dpr);

  // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
  ctx.clearRect(0, 0, width, height);

  // ìºì‹±ëœ ê·¸ë¦¬ê¸° ë°ì´í„°(ë°°ì—´ ë“±)ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  redrawAllFromCache();
}

// ë„êµ¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
penBtn.addEventListener('click', () => {
  toolDropdown.style.display = toolDropdown.style.display === 'block' ? 'none' : 'block';
  eraserBtn.classList.remove('selected');
});

// ë„êµ¬ ì„ íƒ ì´ë²¤íŠ¸
toolDropdown.querySelectorAll('div').forEach(div => {
  div.addEventListener('click', () => {
    currentTool = div.dataset.tool;
    penBtn.textContent = {
      pencil: 'âœï¸ ì—°í•„ â–¼',
      highlighter: 'ğŸ–ï¸ í•˜ì´ë¼ì´í„° â–¼',
      brush: 'ğŸ–Œï¸ ë¶“ â–¼',
    }[currentTool];
    toolDropdown.style.display = 'none';
    eraserBtn.classList.remove('selected');
  });
});

// ì§€ìš°ê°œ ë²„íŠ¼
eraserBtn.addEventListener('click', () => {
  currentTool = 'eraser';
  penBtn.textContent = 'âœï¸ íœ â–¼';
  eraserBtn.classList.add('selected');
  toolDropdown.style.display = 'none';
});

// ìƒ‰ìƒ ì„ íƒ
colorPicker.querySelectorAll('.color-swatch').forEach(swatch => {
  swatch.addEventListener('click', () => {
    colorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    swatch.classList.add('selected');
    currentColor = swatch.dataset.color;
  });
});

// ì´ë¯¸ì§€ ì‚½ì… ëª¨ë‹¬ ì—´ê¸°
addImageBtn.addEventListener('click', () => {
  imageInsertModal.style.display = 'block';
});
imageInsertModal.querySelector('.close-modal').addEventListener('click', () => {
  imageInsertModal.style.display = 'none';
});

// ì´ë¯¸ì§€ ì‚½ì… ì²˜ë¦¬
imageInsertModal.querySelectorAll('.sticker-list img').forEach(img => {
  img.addEventListener('click', () => {
    const imageUrl = img.dataset.url;

    // ì´ë¯¸ì§€ ê°ì²´ ìƒì„±
    const imageObj = new Image();
    imageObj.src = imageUrl;

    imageObj.onload = () => {
      // ë°© ê¶Œí•œ ì²´í¬ í›„ ì‚½ì…
      db.ref(`rooms/${roomId}/members/${currentUser.uid}`).once('value').then(snap => {
        const perms = snap.val();
        if (!perms || !perms.draw) {
          alert('ê·¸ë¦¬ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ì´ë¯¸ì§€ ì‚½ì… ì¢Œí‘œ ê³„ì‚°
        const x = canvas.width / 2 - imageObj.width / 2;
        const y = canvas.height / 2 - imageObj.height / 2;

        ctx.drawImage(imageObj, x, y);

        // DBì— ì´ë¯¸ì§€ ì‚½ì… ì •ë³´ ì €ì¥
        db.ref(`rooms/${roomId}/images`).push({
          url: imageUrl,
          x, y,
          width: imageObj.width,
          height: imageObj.height,
          userId: currentUser.uid,
          timestamp: Date.now()
        });

        imageInsertModal.style.display = 'none';
      });
    };
  });
});

// ê·¸ë¦¬ê¸° í•¨ìˆ˜
function draw(e) {
  if (!drawing || !lastPos) return;

  if (currentTool === 'eraser' && !myPermissions.erase) return;
  if (currentTool !== 'eraser' && !myPermissions.draw) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  ctx.lineCap = 'round';

  if (currentTool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out'; // íˆ¬ëª…í•˜ê²Œ ì§€ìš°ê¸°
    ctx.lineWidth = currentLineWidth;
    ctx.strokeStyle = 'rgba(0,0,0,1)'; // ìƒ‰ìƒì€ ì–´ì°¨í”¼ ì•ˆ ë³´ì„
    ctx.globalAlpha = 1;
  } else {
    ctx.globalCompositeOperation = 'source-over'; // ê¸°ë³¸ ê·¸ë¦¬ê¸° ëª¨ë“œ
    ctx.globalAlpha = currentTool === 'highlighter' ? 0.3 : (currentTool === 'brush' ? 0.8 : 1);
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentLineWidth;
  }

  ctx.beginPath();
  ctx.moveTo(lastPos.x, lastPos.y);
  ctx.lineTo(x, y);
  ctx.stroke();

  const from = { ...lastPos };
  const to = { x, y };
  lastPos = to;

  // DB ì €ì¥
  db.ref(`rooms/${roomId}/drawings`).push({
    tool: currentTool,
    color: currentTool === 'eraser' ? null : currentColor,
    lineWidth: ctx.lineWidth,
    from,
    to,
    userId: currentUser.uid,
    timestamp: Date.now()
  });
}


canvas.addEventListener('mousedown', (e) => {
  console.log("âœ… ë§ˆìš°ìŠ¤ ëˆŒë¦¼!");
  console.log("e.clientX:", e.clientX, "e.clientY:", e.clientY);

  drawing = true;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  lastPos = { x, y };

  draw(e); // ì²« ì  ê·¸ë¦¬ê¸°
});

canvas.addEventListener('mousemove', draw);

canvas.addEventListener('mouseup', () => {
  drawing = false;
  lastPos = null;
});

canvas.addEventListener('mouseout', () => {
  drawing = false;
  lastPos = null;
});

// ê¶Œí•œì— ë”°ë¥¸ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
function updateToolButtons(perms) {
  penBtn.disabled = !perms.draw;
  eraserBtn.disabled = !perms.erase;

  // í˜„ì¬ íˆ´ì´ íœì´ê³  ê¶Œí•œì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì§€ìš°ê°œë¡œ ì „í™˜
  if (!perms.draw && perms.erase) {
    if (currentTool !== 'eraser') {
      currentTool = 'eraser';
      penBtn.textContent = 'âœï¸ íœ â–¼';
      eraserBtn.classList.add('selected');
      penBtn.classList.remove('selected');
    }
  } else if (perms.draw) {
    // ê·¸ë¦¬ê¸° ê¶Œí•œì´ ìˆìœ¼ë©´ ì§€ìš°ê°œ ì„ íƒ í•´ì œ, íœ ì„ íƒ ìœ ì§€
    eraserBtn.classList.remove('selected');
    penBtn.classList.add('selected');
  } else {
    // ê·¸ë¦¬ê¸° ê¶Œí•œ ì—†ê³  ì§€ìš°ê°œ ê¶Œí•œë„ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”, ì„ íƒ í‘œì‹œ ì œê±°
    eraserBtn.classList.remove('selected');
    penBtn.classList.remove('selected');
  }
}


// ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸: ë°© ë°ì´í„° ì‚­ì œ, index.html ì´ë™
closeBtn.addEventListener('click', () => {
  if (!roomId) {
    window.location.href = 'index.html';
    return;
  }

  // ë°© ë°ì´í„° ì™„ì „ ì‚­ì œ (drawings, images, members, ë“± ëª¨ë‘ í¬í•¨)
  db.ref(`rooms/${roomId}`).remove()
    .then(() => {
      alert('ë°©ì´ ì¢…ë£Œë˜ì–´ ëª¨ë“  ì‚¬ìš©ìê°€ í‡´ì¥ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      window.location.href = 'index.html';
    })
    .catch(err => {
      alert('ë°© ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
});

// ë¡œê·¸ì¸ ë° ë°© ì…ì¥ ì²˜ë¦¬
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    return;
  }
  currentUser = user;

  if (!roomId) {
    createRoomBtn.style.display = 'block';
    mainDiv.style.display = 'none';
    chatArea.style.display = 'none';
    return;
  }

  createRoomBtn.style.display = 'none';
  mainDiv.style.display = 'flex';
  chatArea.style.display = 'flex';

  const name = prompt("ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:") || "ì‚¬ìš©ì";

  // ë©¤ë²„ë¡œ ë°© ì…ì¥ (ê¸°ë³¸ ê¶Œí•œ draw/erase false, chat true)
  db.ref(`rooms/${roomId}/members/${currentUser.uid}`).set({
    name: name,
    draw: true,
    erase: true,
    chat: true
  });

  // ë°©ì´ ì—†ìœ¼ë©´ ìƒì„± (hostId ì„¤ì •)
  db.ref(`rooms/${roomId}`).once("value").then(snapshot => {
    if (!snapshot.exists()) {
      return db.ref(`rooms/${roomId}`).set({
        hostId: currentUser.uid,
        createdAt: Date.now()
      });
    }
  }).then(() => {
    // ë°© ì •ë³´ ë¡œë“œ ë° ê¶Œí•œ ë²„íŠ¼ í‘œì‹œ
    db.ref(`rooms/${roomId}`).once('value').then(snap => {
      const roomData = snap.val();
      const isHost = roomData.hostId === currentUser.uid;
      permBtn.style.display = isHost ? 'block' : 'none';

      if (isHost) {
        permBtn.onclick = () => {
          db.ref(`rooms/${roomId}/members`).once('value').then(snap => {
            const members = snap.val();
            const list = Object.entries(members).map(([uid, perms], i) =>
              `${i + 1}. ${perms.name} â†’ ğŸ–Œï¸ ${perms.draw ? 'O' : 'X'} / ğŸ§½ ${perms.erase ? 'O' : 'X'}`
            ).join('\n');
            const input = prompt(`ê¶Œí•œì„ ë³€ê²½í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”:\n${list}`);
            const index = parseInt(input) - 1;
            const uids = Object.keys(members);
            if (isNaN(index) || index < 0 || index >= uids.length) return;
            const selectedUid = uids[index];
            const perms = members[selectedUid];
            db.ref(`rooms/${roomId}/members/${selectedUid}`).update({
              draw: !perms.draw,
              erase: !perms.erase
            }).then(() => alert(`${perms.name}ì˜ ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`));
          });
        };
      }
    });

    // ìì‹ ì˜ ê¶Œí•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
db.ref(`rooms/${roomId}/members/${currentUser.uid}`).on("value", snap => {
  const perms = snap.val();
  if (!perms) return;
  myPermissions = perms; // â† ìºì‹±
  canvas.style.pointerEvents = (perms.draw || perms.erase) ? 'auto' : 'none';
  updateToolButtons(perms);
});

    // ê¸°ì¡´ ê·¸ë¦¬ê¸° ë° ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    loadExistingDrawings();
  });
});

const drawingsCache = [];
const imagesCache = [];

db.ref(`rooms/${roomId}/drawings`).on('child_added', snap => {
  const data = snap.val();
  if (!data) return;
  drawingsCache.push(data);
  // ë¦¬ë Œë”ë§ì€ debounce ì²˜ë¦¬ ë˜ëŠ” ë”°ë¡œ ì»¨íŠ¸ë¡¤
  scheduleRedraw();
});

db.ref(`rooms/${roomId}/images`).on('child_added', snap => {
  const data = snap.val();
  if (!data) return;
  imagesCache.push(data);
  scheduleRedraw();
});

let redrawTimeout = null;
function scheduleRedraw() {
  if (redrawTimeout) clearTimeout(redrawTimeout);
  redrawTimeout = setTimeout(() => {
    resizeCanvasAndRedraw();
  }, 100); // 0.1ì´ˆ í›„ì— ê·¸ë¦¬ê¸° ì‹¤í–‰ (ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¤‘ë³µ ë°©ì§€)
}

function redrawAllFromCache() {
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;

  ctx.clearRect(0, 0, width, height);

  drawingsCache.forEach(data => {
    ctx.lineCap = 'round';

    if (data.tool === 'eraser') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.globalAlpha = 1;
      ctx.lineWidth = data.lineWidth || 20;
      ctx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.globalAlpha = data.tool === 'highlighter' ? 0.3 : 1;
      ctx.strokeStyle = data.color || '#000';
      ctx.lineWidth = data.lineWidth || 2;
    }

    ctx.beginPath();
    ctx.moveTo(data.from.x, data.from.y);
    ctx.lineTo(data.to.x, data.to.y);
    ctx.stroke();
  });

  // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
  imagesCache.forEach(imgData => {
    const imageObj = new Image();
    imageObj.src = imgData.url;
    imageObj.onload = () => {
      ctx.drawImage(imageObj, imgData.x, imgData.y, imgData.width, imgData.height);
    };
  });
}


// ì±„íŒ… ë³´ë‚´ê¸°
document.getElementById('sendChat').addEventListener('click', sendChat);
document.getElementById('chatText').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendChat();
});

function sendChat() {
  const input = document.getElementById('chatText');
  const text = input.value.trim();
  if (!text || !roomId || !currentUser) return;

  db.ref(`rooms/${roomId}/chats`).push({
    uid: currentUser.uid,
    name: myPermissions?.name || 'ìµëª…',
    text: text,
    timestamp: Date.now()
  });

  input.value = '';
}

// ì±„íŒ… ìˆ˜ì‹ 
db.ref(`rooms/${roomId}/chats`).on('child_added', snap => {
  const data = snap.val();
  if (!data || !data.text) return;

  const msgDiv = document.createElement('div');
  msgDiv.style.marginBottom = '8px';
  msgDiv.style.wordBreak = 'break-word';
  msgDiv.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
  document.getElementById('chatMessages').appendChild(msgDiv);

  // ìë™ ìŠ¤í¬ë¡¤
  const chatBox = document.getElementById('chatMessages');
  chatBox.scrollTop = chatBox.scrollHeight;
});

const defaultLineWidths = {
  pencil: 2,
  highlighter: 15,
  brush: 8,
  eraser: 20
};

// í˜„ì¬ êµµê¸° ê°’ ë³€ìˆ˜ (ì´ˆê¸°ê°’ì€ pencil ê¸°ì¤€)
let currentLineWidth = defaultLineWidths.pencil;

const lineWidthRange = document.getElementById('lineWidthRange');

// ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ì²˜ë¦¬
lineWidthRange.addEventListener('input', () => {
  currentLineWidth = parseInt(lineWidthRange.value, 10);
});

// ë„êµ¬ ë³€ê²½ ì‹œ ìŠ¬ë¼ì´ë” ì´ˆê¸°ê°’ ì„¸íŒ… í•¨ìˆ˜
function updateLineWidthSlider(tool) {
  if (tool === 'eraser') {
    lineWidthRange.min = 5;
    lineWidthRange.max = 150;
    lineWidthRange.step = 1;
    currentLineWidth = defaultLineWidths.eraser;
    lineWidthRange.value = currentLineWidth;
  } else if (tool === 'highlighter') {
    lineWidthRange.min = 5;
    lineWidthRange.max = 50;
    lineWidthRange.step = 1;
    currentLineWidth = defaultLineWidths.highlighter;
    lineWidthRange.value = currentLineWidth;
  } else if (tool === 'brush') {
    lineWidthRange.min = 1;
    lineWidthRange.max = 50;
    lineWidthRange.step = 1;
    currentLineWidth = defaultLineWidths.brush;
    lineWidthRange.value = currentLineWidth;
  } else {
    // pencil í¬í•¨ ê¸°íƒ€ ë„êµ¬
    lineWidthRange.min = 1;
    lineWidthRange.max = 20;
    lineWidthRange.step = 1;
    currentLineWidth = defaultLineWidths.pencil;
    lineWidthRange.value = currentLineWidth;
  }
}

// ì´ˆê¸° íˆ´ë³„ êµµê¸° ì„¸íŒ…
updateLineWidthSlider(currentTool);

// ë„êµ¬ ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ
toolDropdown.querySelectorAll('div').forEach(div => {
  div.addEventListener('click', () => {
    currentTool = div.dataset.tool;
    penBtn.textContent = {
      pencil: 'âœï¸ ì—°í•„ â–¼',
      highlighter: 'ğŸ–ï¸ í•˜ì´ë¼ì´í„° â–¼',
      brush: 'ğŸ–Œï¸ ë¶“ â–¼',
    }[currentTool];
    toolDropdown.style.display = 'none';
    eraserBtn.classList.remove('selected');

    // ìŠ¬ë¼ì´ë” êµµê¸°ê°’ ì—…ë°ì´íŠ¸
    updateLineWidthSlider(currentTool);
  });
});

// ì§€ìš°ê°œ ë²„íŠ¼ í´ë¦­ ì‹œ
eraserBtn.addEventListener('click', () => {
  currentTool = 'eraser';
  penBtn.textContent = 'âœï¸ íœ â–¼';
  eraserBtn.classList.add('selected');
  toolDropdown.style.display = 'none';

  // ìŠ¬ë¼ì´ë” êµµê¸°ê°’ ì—…ë°ì´íŠ¸ (ì§€ìš°ê°œìš©)
  updateLineWidthSlider('eraser');
});

// draw í•¨ìˆ˜ ë‚´ì—ì„œ ctx.lineWidthë¥¼ currentLineWidth ê°’ ì‚¬ìš©
function draw(e) {
  if (!drawing || !lastPos) return;

  if (currentTool === 'eraser' && !myPermissions.erase) return;
  if (currentTool !== 'eraser' && !myPermissions.draw) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  ctx.lineCap = 'round';

  switch (currentTool) {
    case 'pencil':
      ctx.globalAlpha = 1;
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentLineWidth;
      break;
    case 'highlighter':
      ctx.globalAlpha = 0.3;
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentLineWidth;
      break;
    case 'brush':
      ctx.globalAlpha = 0.8;
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentLineWidth;
      break;
    case 'eraser':
      ctx.globalAlpha = 1;
      ctx.strokeStyle = '#f5f7fb';
      ctx.lineWidth = currentLineWidth;
      break;
  }

  ctx.beginPath();
  ctx.moveTo(lastPos.x, lastPos.y);
  ctx.lineTo(x, y);
  ctx.stroke();

  const from = { ...lastPos };
  const to = { x, y };
  lastPos = to;

  // DB ì €ì¥
  db.ref(`rooms/${roomId}/drawings`).push({
    tool: currentTool,
    color: currentTool === 'eraser' ? null : currentColor,
    lineWidth: ctx.lineWidth,
    from,
    to,
    userId: currentUser.uid,
    timestamp: Date.now()
  });
}

  </script>

</body>
</html>
